(()=>{var f=Object.defineProperty,v=Object.defineProperties;var y=Object.getOwnPropertyDescriptors;var w=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,S=Object.prototype.propertyIsEnumerable;var g=(o,e,t)=>e in o?f(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,p=(o,e)=>{for(var t in e||(e={}))E.call(e,t)&&g(o,t,e[t]);if(w)for(var t of w(e))S.call(e,t)&&g(o,t,e[t]);return o},m=(o,e)=>v(o,y(e));var h=class{constructor(){this.sessionKey=this.generateSessionKey(),this.eventBuffer=[],this.isRecording=!1,this.batchSize=50,this.batchTimeout=5e3,this.lastBatchTime=Date.now(),this.settings={apiEndpoint:"https://your-app-url.com/api/events",batchSize:50,batchTimeout:5e3,enableMouseTracking:!0,enableScrollTracking:!0,enableFormTracking:!0,maskSensitiveData:!0},this.init()}generateSessionKey(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}init(){window.sessionKey=this.sessionKey,this.shouldStartRecording()&&this.startRecording(),this.setupConsentListener()}shouldStartRecording(){return window.Shopify&&window.Shopify.customerPrivacy&&window.Shopify.customerPrivacy.getTrackingConsent&&window.Shopify.customerPrivacy.getTrackingConsent().marketing}setupConsentListener(){window.Shopify&&window.Shopify.customerPrivacy&&window.Shopify.customerPrivacy.onTrackingConsentChanged(()=>{this.shouldStartRecording()&&!this.isRecording?this.startRecording():!this.shouldStartRecording()&&this.isRecording&&this.stopRecording()})}startRecording(){this.isRecording||(this.isRecording=!0,console.log("Session replay recording started"),this.recordEvent({type:"page_load",timestamp:Date.now(),url:window.location.href,viewport:{width:window.innerWidth,height:window.innerHeight}}),this.setupEventListeners(),this.startBatchProcessor())}stopRecording(){this.isRecording&&(this.isRecording=!1,console.log("Session replay recording stopped"),this.removeEventListeners(),this.flushBuffer())}setupEventListeners(){this.settings.enableMouseTracking&&(this.addThrottledListener("mousemove",this.handleMouseMove.bind(this)),this.addThrottledListener("mousedown",this.handleMouseDown.bind(this)),this.addThrottledListener("mouseup",this.handleMouseUp.bind(this)),this.addThrottledListener("click",this.handleClick.bind(this))),this.settings.enableScrollTracking&&this.addThrottledListener("scroll",this.handleScroll.bind(this)),this.settings.enableFormTracking&&(this.addThrottledListener("input",this.handleInput.bind(this)),this.addThrottledListener("change",this.handleChange.bind(this)),this.addThrottledListener("focus",this.handleFocus.bind(this)),this.addThrottledListener("blur",this.handleBlur.bind(this))),this.addListener("resize",this.handleResize.bind(this)),this.addListener("beforeunload",this.handleBeforeUnload.bind(this))}removeEventListeners(){window.removeEventListener("mousemove",this.throttledMouseMove),window.removeEventListener("mousedown",this.throttledMouseDown),window.removeEventListener("mouseup",this.throttledMouseUp),window.removeEventListener("click",this.throttledClick),window.removeEventListener("scroll",this.throttledScroll),window.removeEventListener("input",this.throttledInput),window.removeEventListener("change",this.throttledChange),window.removeEventListener("focus",this.throttledFocus),window.removeEventListener("blur",this.throttledBlur),window.removeEventListener("resize",this.handleResize),window.removeEventListener("beforeunload",this.handleBeforeUnload)}addThrottledListener(e,t,i=100){let s=this.throttle(t,i);window.addEventListener(e,s),this[`throttled${e.charAt(0).toUpperCase()+e.slice(1)}`]=s}addListener(e,t){window.addEventListener(e,t)}throttle(e,t){let i,s=0;return function(...n){let r=Date.now();r-s>t?(e.apply(this,n),s=r):(clearTimeout(i),i=setTimeout(()=>{e.apply(this,n),s=Date.now()},t-(r-s)))}}handleMouseMove(e){this.recordEvent({type:"mouse_move",timestamp:Date.now(),x:e.clientX,y:e.clientY,target:this.getElementSelector(e.target)})}handleMouseDown(e){this.recordEvent({type:"mouse_down",timestamp:Date.now(),x:e.clientX,y:e.clientY,button:e.button,target:this.getElementSelector(e.target)})}handleMouseUp(e){this.recordEvent({type:"mouse_up",timestamp:Date.now(),x:e.clientX,y:e.clientY,button:e.button,target:this.getElementSelector(e.target)})}handleClick(e){var t;this.recordEvent({type:"click",timestamp:Date.now(),x:e.clientX,y:e.clientY,target:this.getElementSelector(e.target),text:(t=e.target.textContent)==null?void 0:t.slice(0,100)})}handleScroll(e){this.recordEvent({type:"scroll",timestamp:Date.now(),scrollX:window.scrollX,scrollY:window.scrollY,target:this.getElementSelector(e.target)})}handleInput(e){let t=this.settings.maskSensitiveData?this.maskSensitiveData(e.target.value,e.target):e.target.value;this.recordEvent({type:"input",timestamp:Date.now(),target:this.getElementSelector(e.target),value:t,inputType:e.inputType})}handleChange(e){let t=this.settings.maskSensitiveData?this.maskSensitiveData(e.target.value,e.target):e.target.value;this.recordEvent({type:"change",timestamp:Date.now(),target:this.getElementSelector(e.target),value:t})}handleFocus(e){this.recordEvent({type:"focus",timestamp:Date.now(),target:this.getElementSelector(e.target)})}handleBlur(e){this.recordEvent({type:"blur",timestamp:Date.now(),target:this.getElementSelector(e.target)})}handleResize(e){this.recordEvent({type:"resize",timestamp:Date.now(),width:window.innerWidth,height:window.innerHeight})}handleBeforeUnload(e){this.recordEvent({type:"page_unload",timestamp:Date.now()}),this.flushBuffer(!0)}getElementSelector(e){if(!e||e===document)return"document";let t="",i=e;for(;i&&i!==document.body;){let s=i.tagName.toLowerCase();if(i.id){s+=`#${i.id}`,t=s+(t?" > "+t:"");break}else i.className&&(s+=`.${i.className.split(" ").join(".")}`);t=s+(t?" > "+t:""),i=i.parentElement}return t}maskSensitiveData(e,t){var d,l,c,u;if(!e||!t)return e;let i=(d=t.tagName)==null?void 0:d.toLowerCase(),s=(l=t.type)==null?void 0:l.toLowerCase(),n=(c=t.name)==null?void 0:c.toLowerCase(),r=(u=t.id)==null?void 0:u.toLowerCase();return["email","password","credit","card","cvv","cvc","ssn","social","phone","address","zip","postal"].some(a=>(i==null?void 0:i.includes(a))||(s==null?void 0:s.includes(a))||(n==null?void 0:n.includes(a))||(r==null?void 0:r.includes(a)))&&e.length>0?"\u2022\u2022\u2022\u2022\u2022":e}recordEvent(e){this.isRecording&&(this.eventBuffer.push(m(p({},e),{sessionKey:this.sessionKey,url:window.location.href,timestamp:Date.now()})),this.eventBuffer.length>=this.batchSize&&this.flushBuffer())}startBatchProcessor(){setInterval(()=>{Date.now()-this.lastBatchTime>=this.batchTimeout&&this.eventBuffer.length>0&&this.flushBuffer()},this.batchTimeout)}flushBuffer(e=!1){if(this.eventBuffer.length===0)return;let t=[...this.eventBuffer];this.eventBuffer=[],this.lastBatchTime=Date.now(),this.sendEvents(t,e)}sendEvents(e,t=!1){var s;let i={sessionKey:this.sessionKey,events:e,metadata:{userAgent:navigator.userAgent,url:window.location.href,timestamp:Date.now(),shopDomain:((s=window.Shopify)==null?void 0:s.shop)||"unknown"}};if(t)try{let n=new XMLHttpRequest;n.open("POST",this.settings.apiEndpoint,!1),n.setRequestHeader("Content-Type","application/json"),n.send(JSON.stringify(i))}catch(n){console.error("Error sending events synchronously:",n)}else fetch(this.settings.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).catch(n=>{console.error("Error sending events:",n)})}};typeof window!="undefined"&&(window.sessionReplayPixel=new h);})();
//# sourceMappingURL=session-replay-pixel.js.map
